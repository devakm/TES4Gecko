package TES4Gecko;

import java.io.*;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.ListIterator;
import java.util.Map;
import java.util.Vector;
import java.util.zip.DataFormatException;

import java.awt.*;
import java.awt.event.*;
import javax.swing.*;
import javax.swing.event.*;

/**
 * Dialog to edit the plugin master list
 */
public class RegionCellDialog extends JDialog implements ActionListener {
    
    /** Plugin file */
    private File pluginFile;
    
    /** Master list box */
    private JList regionList;
    
    private JButton doneButton;
    
    private String regionsToExport = ALL;
    private Vector<String[]> regionListData;
    
    public static final String NONE = "None";
    public static final String ALL = "All";
    public static final String SOME = "Some";
    public static final String SEPARATOR = ":";
    
    class cellRenderer extends JPanel implements ListCellRenderer
    {
    	JPanel testPanel = null;
    	//JPanel thisPanel = null;
    	JLabel plugin = null;
    	JLabel worldspace = null;
    	JLabel region = null;
     
    	cellRenderer()
    	{
    		plugin = new JLabel("",10);
    		worldspace = new JLabel("",10);
    		region = new JLabel("",10);
    		testPanel = new JPanel();
    		testPanel.setLayout(new GridLayout(1,3));
    		testPanel.add(plugin);
    		testPanel.add(worldspace);
    		testPanel.add(region);
    	}
    	public Component getListCellRendererComponent(JList list, Object value, int idx, boolean isSel, boolean hasFocus)
    	{
    		if (value!=null)
    		{
    			// Object has to be an array of length 4of strings:
    			// index 0 - Form ID (not displayed)
    			// index 1 - Plugin file name
    			// index 2 - Worldspace name
    			// index 3 - Region name
    			String[] regionInfo = (String[]) value;
    			plugin.setText(regionInfo[1]); 
    			worldspace.setText(regionInfo[2]); 
    			region.setText(regionInfo[3]); 
    		}
    		testPanel.setBackground((isSel)?list.getSelectionBackground():list.getBackground());
    		testPanel.setForeground((isSel)?list.getSelectionForeground():list.getForeground());
    		//testPanel.setSize(30,30);
    		return testPanel;
    	}
    }


    /**
     * Create the dialog
     *
     * @param       parent          Parent frame
     * @param       pluginFile      Plugin file
     * @param       plugin          Plugin
     */
    public RegionCellDialog(JFrame parent, File pluginFile, Vector<String[]> regionData) {
        super(parent, pluginFile.getName(), true);
        setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);
        this.pluginFile = pluginFile;
        regionListData = regionData;
        //
        // Display master list for the plugin
        //
        regionList = new JList(regionData);
        // The following listener disables "done" if there is no selection made.
        ListSelectionListener listListener = new ListSelectionListener() {
        	public void valueChanged(ListSelectionEvent e) {
        	    if (e.getValueIsAdjusting() == false) {

        	        if (regionList.getSelectedIndices().length == 0) {
        	        //No selection, disable done button.
        	            doneButton.setEnabled(false);

        	        } else {
        	        //Selection, enable the fire button.
        	            doneButton.setEnabled(true);
        	        }
        	    }
        	}        }
        regionList.setSelectionMode(ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);
        regionList.setPrototypeCellValue("mmmmmmmmmmmmmmmmmmmmmmmmm");
        regionList.addListSelectionListener(listListener);
        regionList.setCellRenderer(new cellRenderer());
        JScrollPane listPane = new JScrollPane(regionList);
        
        //
        // Create the buttons
        //
        JRadioButton allButton   = new JRadioButton("Merge all exterior cells" , true);
        JRadioButton noneButton    = new JRadioButton("Merge no exterior cells", false);
        JRadioButton selectButton = new JRadioButton("Select regions with exterior cells to be merged", false);

        ButtonGroup bgroup = new ButtonGroup();
        allButton.setActionCommand("merge all");
        allButton.addActionListener(this);
        bgroup.add(allButton);
        noneButton.setActionCommand("merge none");
        noneButton.addActionListener(this);
        bgroup.add(noneButton);
        selectButton.setActionCommand("merge some");
        selectButton.addActionListener(this);
        bgroup.add(selectButton);

        JPanel radioPanel = new JPanel();
        radioPanel.setLayout(new GridLayout(3, 1));
        radioPanel.add(allButton);
        radioPanel.add(noneButton);
        radioPanel.add(selectButton);

        JPanel buttonPane = new JPanel();
        buttonPane.setLayout(new BoxLayout(buttonPane, BoxLayout.X_AXIS));
        buttonPane.setBackground(Main.backgroundColor);

        doneButton = new JButton("Done");
        doneButton.setActionCommand("done");
        doneButton.addActionListener(this);
        buttonPane.add(doneButton);

        JButton button = new JButton("Cancel");
        button.setActionCommand("cancel");
        button.addActionListener(this);
        buttonPane.add(button);

        //
        // Set up the content pane
        //
        JPanel contentPane = new JPanel();
        contentPane.setLayout(new BoxLayout(contentPane, BoxLayout.Y_AXIS));
        contentPane.setOpaque(true);
        contentPane.setBackground(Main.backgroundColor);
        contentPane.setBorder(BorderFactory.createEmptyBorder(30, 30, 30, 30));
        contentPane.add(listPane);
        contentPane.add(Box.createHorizontalStrut(15));
        contentPane.add(buttonPane);
        setContentPane(contentPane);        
        
        // Add listener for window closing events; set 
        addWindowListener(new WindowAdapter()
        {
        	public void windowClosing(WindowEvent e)
        	{
        		// Close-dialog icon was clicked, so set export to ALL.
        		regionsToExport = ALL;
                setVisible(false);
        		dispose();
            }
        });
    }

    /**
     * Show the dialog
     *
     * @param       parent          Parent frame
     * @param       pluginFile      Plugin file
     * @param       plugin          Plugin
     */
    public static String showDialog(JFrame parent, File pluginFile, Vector<String[]> regionData)
    {
    	RegionCellDialog dialog = new RegionCellDialog(parent, pluginFile, regionData);
        dialog.pack();
        dialog.setLocationRelativeTo(parent);
        dialog.setVisible(true);
        return dialog.regionsToExport;
    }
    
    /**
     * Action performed (ActionListener interface)
     *
     * @param       ae              Action event
     */
    public void actionPerformed(ActionEvent ae)
    {
        String action = ae.getActionCommand();
        try
        {
            if (action.equals("merge all"))
            {
                regionList.clearSelection();
                regionList.setEnabled(false);
                doneButton.setEnabled(true);
                regionsToExport = ALL;
            }
            else if (action.equals("merge none"))
            {
                regionList.clearSelection();
                regionList.setEnabled(false);
                doneButton.setEnabled(true);
                regionsToExport = NONE;
            }
            else if (action.equals("merge some"))
            {
                regionList.setEnabled(true);
                doneButton.setEnabled(false);
                regionsToExport = SOME;
            }
            else if (action.equals("cancel")) // By default, export all exterior cells.
            {
                regionsToExport = ALL;
                setVisible(false);
                dispose();
            }
            else if (action.equals("done"))
            {
            	if (regionsToExport.equals(SOME))
            	{
            		Object[] valueArray = regionList.getSelectedValues();
            		for (int i = 0; i < valueArray.length; i++)
            		{
            			String[] regionValues = (String[]) (valueArray[i])
            			regionsToExport += "|" + regionValues[0]; // First values is Form ID.
            		}
            	}
            }
        } catch (Throwable exc) {
            Main.logException("Exception while processing action event " + action, exc);
        }   
    }
}
